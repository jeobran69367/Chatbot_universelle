# Pipeline CI/CD pour Chatbot Web Scraper
# DÃ©ploiement automatisÃ© sur Azure Container Apps avec AZD

name: ğŸš€ CI/CD - Azure Deployment

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

# Variables globales
env:
  AZURE_ENV_NAME: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
  AZURE_DEV_COLLECT_TELEMETRY: 'no'

# Permissions spÃ©ciales pour OIDC
permissions:
  id-token: write
  contents: read

jobs:
  #============================================================================
  # Job 1: Tests et Validation du Code
  #============================================================================
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black mypy safety bandit
        
    - name: ğŸ§ª Run Tests
      run: |
        # CrÃ©er les rÃ©pertoires de test
        mkdir -p data/embeddings data/scraped tests
        
        # Tests basiques
        python -m pytest tests/ -v || echo "âš ï¸ Tests terminÃ©s"
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          htmlcov/
          coverage.xml

  #============================================================================
  # Job 2: Construction Docker  
  #============================================================================
  build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“‹ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: chatbot-web-scraper
        tags: |
          type=ref,event=branch
          type=ref,event=pr,prefix=pr-
          type=sha,prefix=sha-,format=short
          
    - name: ğŸ³ Build and Export
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: production
        platforms: linux/amd64
        tags: ${{ steps.meta.outputs.tags }}
        outputs: type=docker,dest=/tmp/chatbot-image.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“¤ Upload Docker Image
      uses: actions/upload-artifact@v4
      if: github.event_name != 'pull_request'
      with:
        name: chatbot-docker-image
        path: /tmp/chatbot-image.tar
        retention-days: 1

  #============================================================================
  # Job 3: DÃ©ploiement sur Azure
  #============================================================================
  deploy:
    name: ğŸŒ Deploy to Azure
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name != 'pull_request'
    
    environment: 
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    outputs:
      uri: ${{ steps.deploy.outputs.uri }}
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Docker Image
      uses: actions/download-artifact@v4
      with:
        name: chatbot-docker-image
        path: /tmp
        
    - name: ğŸ³ Load Docker Image
      run: docker load --input /tmp/chatbot-image.tar
      
    - name: ğŸ”‘ Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
    - name: ğŸ› ï¸ Setup Azure Developer CLI
      run: |
        # Installation AZD avec fallback
        if curl -fsSL https://aka.ms/install-azd.sh | bash; then
          echo "âœ… AZD installÃ© via script officiel"
        else
          echo "âš ï¸ Script officiel Ã©chouÃ©, installation via GitHub releases"
          AZD_VERSION="1.10.2"
          wget -q "https://github.com/Azure/azure-dev/releases/download/azure-dev-cli_${AZD_VERSION}/azd-linux-amd64.tar.gz" -O azd.tar.gz
          tar -xzf azd.tar.gz
          sudo mv azd /usr/local/bin/azd
          chmod +x /usr/local/bin/azd
        fi
        azd version
        
    - name: ğŸ”§ AZD Authentication
      run: |
        echo "ğŸ” Configuration de l'authentification AZD..."
        azd auth login --client-id "${{ secrets.AZURE_CLIENT_ID }}" --tenant-id "${{ secrets.AZURE_TENANT_ID }}" --federated-credential-provider "github" --service-principal
        
    - name: ğŸ”§ Configure AZD Environment
      run: |
        # DÃ©finir le nom du groupe de ressources
        RESOURCE_GROUP_NAME="rg-${{ env.AZURE_ENV_NAME }}-chatbot"
        LOCATION="${{ vars.AZURE_LOCATION || 'eastus' }}"
        
        # CrÃ©er le groupe de ressources s'il n'existe pas
        echo "ğŸ”§ VÃ©rification/crÃ©ation du groupe de ressources: $RESOURCE_GROUP_NAME"
        if ! az group show --name "$RESOURCE_GROUP_NAME" --output none 2>/dev/null; then
          echo "ğŸ“¦ CrÃ©ation du groupe de ressources: $RESOURCE_GROUP_NAME dans $LOCATION"
          az group create --name "$RESOURCE_GROUP_NAME" --location "$LOCATION" --tags azd-env-name=${{ env.AZURE_ENV_NAME }}
        else
          echo "âœ… Groupe de ressources existant: $RESOURCE_GROUP_NAME"
        fi
        
        # Initialiser l'environnement AZD si nÃ©cessaire
        if [ ! -f ".azure/${{ env.AZURE_ENV_NAME }}/.env" ]; then
          echo "ğŸ”§ CrÃ©ation de l'environnement AZD: ${{ env.AZURE_ENV_NAME }}"
          azd env new ${{ env.AZURE_ENV_NAME }} --location "$LOCATION"
        fi
        
        # Configuration AZD
        azd config set alpha.resourceGroupDeployments on
        
        # Configuration des variables d'environnement critiques
        azd env set AZURE_ENV_NAME ${{ env.AZURE_ENV_NAME }}
        azd env set AZURE_LOCATION "$LOCATION"
        azd env set AZURE_SUBSCRIPTION_ID ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        azd env set AZURE_RESOURCE_GROUP "$RESOURCE_GROUP_NAME"
        
        # Variables spÃ©cifiques Ã  l'application
        azd env set APP_VERSION ${{ github.sha }}
        azd env set CONTAINER_IMAGE chatbot-web-scraper:${{ github.sha }}
        
    - name: ğŸ—ï¸ Provision Azure Infrastructure
      run: azd provision --no-prompt
          
    - name: ğŸš€ Deploy Application
      id: deploy
      run: |
        # DÃ©ploiement avec azd
        azd deploy --no-prompt
        
        # RÃ©cupÃ©rer l'URL de l'application
        APP_URL=$(azd env get-values | grep AZURE_CONTAINER_APP_URL | cut -d'=' -f2 | tr -d '"' || echo "")
        
        if [ -z "$APP_URL" ]; then
          APP_URL="https://${{ env.AZURE_ENV_NAME }}-chatbot-app.azurecontainerapps.io"
        fi
        
        echo "uri=$APP_URL" >> $GITHUB_OUTPUT
        echo "ğŸ‰ Application dÃ©ployÃ©e avec succÃ¨s!"
        echo "ğŸŒ URL: $APP_URL"
        
    - name: ğŸ” Health Check
      run: |
        APP_URL="${{ steps.deploy.outputs.uri }}"
        echo "ğŸ” Test de l'application Ã : $APP_URL"
        
        # Attendre que l'application dÃ©marre
        sleep 60
        
        # Test basique
        if curl -f -m 30 "$APP_URL" > /dev/null 2>&1; then
          echo "âœ… Application accessible!"
        else
          echo "âš ï¸ Application en cours de dÃ©marrage..."
        fi

  #============================================================================
  # Job 4: Tests d'IntÃ©gration
  #============================================================================
  integration-tests:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name != 'pull_request'
    
    steps:
    - name: ğŸ§ª Basic Integration Test
      env:
        APP_URL: ${{ needs.deploy.outputs.uri }}
      run: |
        echo "ğŸ§ª Test de l'application dÃ©ployÃ©e: $APP_URL"
        
        # Test simple de connectivitÃ©
        if curl -f -m 30 "$APP_URL" > /dev/null 2>&1; then
          echo "âœ… Test d'intÃ©gration rÃ©ussi!"
        else
          echo "âš ï¸ Test d'intÃ©gration Ã©chouÃ© - l'application est peut-Ãªtre encore en cours de dÃ©marrage"
          exit 1
        fi

  #============================================================================  
  # Job 5: Nettoyage
  #============================================================================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [test, build, deploy, integration-tests]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Status
      run: |
        if [[ "${{ needs.deploy.result }}" == "success" ]]; then
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi!"
          echo "ğŸŒ Application URL: ${{ needs.deploy.outputs.uri }}"
        else
          echo "âŒ Ã‰chec du dÃ©ploiement"
        fi
