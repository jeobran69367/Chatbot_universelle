# Configuration Azure Developer CLI (azd)
# D√©ploiement automatis√© de l'application Chatbot Web Scraper

name: chatbot-web-scraper
metadata:
  template: chatbot-web-scraper@0.0.1-beta

# Configuration du service principal
services:
  chatbot-app:
    project: .
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile
      context: .
      target: production

# Hooks de d√©ploiement
hooks:
  # Avant le provisioning
  preprovision:
    shell: sh
    run: |
      echo "üöÄ Pr√©paration du d√©ploiement..."
      # Cr√©er les r√©pertoires n√©cessaires
      mkdir -p data/embeddings data/scraped data/models logs
      
  # Apr√®s le provisioning
  postprovision:
    shell: sh
    run: |
      echo "‚úÖ Infrastructure provisionn√©e avec succ√®s!"
      echo "üìã Informations du d√©ploiement :"
      echo "   - Resource Group: $AZURE_RESOURCE_GROUP"
      echo "   - Container App URL: $AZURE_CONTAINER_APP_URL"
      echo "   - Registry: $AZURE_CONTAINER_REGISTRY_ENDPOINT"
      
  # Avant le d√©ploiement
  predeploy:
    shell: sh
    run: |
      echo "üî® Construction et push de l'image Docker..."
      # Tag de l'image avec la registry Azure
      docker build -t $AZURE_CONTAINER_REGISTRY_ENDPOINT/chatbot-web-scraper:latest .
      
      # Login √† Azure Container Registry
      az acr login --name $AZURE_CONTAINER_REGISTRY_NAME
      
      # Push de l'image
      docker push $AZURE_CONTAINER_REGISTRY_ENDPOINT/chatbot-web-scraper:latest
      
  # Apr√®s le d√©ploiement
  postdeploy:
    shell: sh
    run: |
      echo "üéâ D√©ploiement termin√© avec succ√®s!"
      echo "üåê Application disponible √†: $AZURE_CONTAINER_APP_URL"
      echo "üìä Monitoring: Application Insights configur√©"
      echo "üíæ Stockage: Azure Storage configur√©"
      echo "üîÑ Cache: Redis configur√©"
      
      # Test de sant√© optionnel
      echo "üîç Test de sant√© de l'application..."
      sleep 30  # Attendre que l'app d√©marre
      if curl -f "$AZURE_CONTAINER_APP_URL/api/status" > /dev/null 2>&1; then
        echo "‚úÖ Application en ligne et fonctionnelle!"
      else
        echo "‚ö†Ô∏è L'application pourrait avoir besoin de plus de temps pour d√©marrer"
      fi
